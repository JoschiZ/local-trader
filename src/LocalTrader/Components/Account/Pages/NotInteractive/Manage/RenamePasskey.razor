@page "/Account/Manage/RenamePasskey/{Id}"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using System.Buffers.Text
@using LocalTrader.Data.User

@inject UserManager<ApplicationUser> UserManager
@inject IdentityRedirectManager RedirectManager

<EditForm Model="Input" OnValidSubmit="Rename" FormName="rename-passkey" method="post">
    <DataAnnotationsValidator/>
    @if (_passkey?.Name is { } name)
    {
        <h4>Enter a new name for your "@name" passkey</h4>
    }
    else
    {
        <h4>Enter a name for your passkey</h4>
    }
    <hr/>
    <ValidationSummary class="text-danger" role="alert"/>
    <div class="form-floating mb-3">
        <MudStaticTextField @bind-Value="@Input.Name" Label="Passkey name" Placeholder="My passkey" For="() => Input.Name" UserAttributes="@(new Dictionary<string, object?> { { "aria-required", "true" } })"></MudStaticTextField>
        <ValidationMessage For="() => Input.Name" class="text-danger"/>
    </div>
    <div>
        <MudStaticButton FormAction="FormAction.Submit" Color="Color.Primary" Variant="Variant.Filled">Save</MudStaticButton>
    </div>
</EditForm>

@code {
    private ApplicationUser? _user;
    private UserPasskeyInfo? _passkey;

    [CascadingParameter] private HttpContext HttpContext { get; set; } = null!;

    [Parameter] public string? Id { get; set; }

    [SupplyParameterFromForm] private InputModel Input { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        _user = (await UserManager.GetUserAsync(HttpContext.User))!;
        if (_user is null)
        {
            RedirectManager.RedirectToInvalidUser(UserManager, HttpContext);
            return;
        }

        byte[] credentialId;
        try
        {
            credentialId = Base64Url.DecodeFromChars(Id);
        }
        catch (FormatException)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey ID had an invalid format.", HttpContext);
            return;
        }

        _passkey = await UserManager.GetPasskeyAsync(_user, credentialId);
        if (_passkey is null)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The specified passkey could not be found.", HttpContext);
            return;
        }
    }

    private async Task Rename()
    {
        _passkey!.Name = Input.Name;
        var result = await UserManager.AddOrUpdatePasskeyAsync(_user!, _passkey);
        if (!result.Succeeded)
        {
            RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Error: The passkey could not be updated.", HttpContext);
            return;
        }

        RedirectManager.RedirectToWithStatus("Account/Manage/Passkeys", "Passkey updated successfully.", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [StringLength(200, ErrorMessage = "Passkey names must be no longer than {1} characters.")]
        public string Name { get; set; } = "";
    }

}